# RNA-seq Analysis Pipeline with Reproducible Nix Environment

[![Reproducible with Nix](https://img.shields.io/badge/Reproducible-Nix-blue?logo=nixos)](https://nixos.org)
[![GitHub Actions CI](https://github.com/Sowmya-Harsh/RNA-Seq_RAP/actions/workflows/ci.yml/badge.svg)](https://sowmya-harsh.github.io/RNA-Seq_RAP/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## Overview

This repository contains a complete, reproducible RNA-seq differential expression analysis pipeline using DESeq2. The entire analysis environment is managed with **Nix**, ensuring that anyone can run this analysis and get **identical results**, regardless of their operating system or local dependencies.

**Key Features:**
- Fully reproducible analysis environment with pinned dependencies (managed by `rix`)
- One-command execution: `nix-shell --run "Rscript run_pipeline.R"`
- Tests to verify the setup
- Automated CI/CD with GitHub Actions

---

## Why Nix for Reproducibility?

### The Problem We're Solving

Imagine you publish a research paper with computational results. A colleague tries to reproduce your analysis 6 months later and gets **different numbers**. Why? 

Common reasons:
- Package versions changed on their system
- Python/R upgraded with breaking changes
- System libraries updated (BLAS, LAPACK versions differ)
- Different operating system (macOS vs Linux results slightly differ

**This is a crisis in computational science.** The National Institutes of Health (NIH) found that ~50% of published research cannot be reproduced due to computational irreproducibility.

## Quick Start

### One-Command Execution

If you have Nix installed, run the entire analysis and generate the report in one command:

```bash
nix-shell --run "Rscript run_pipeline.R"
```

That's it! This will:
1. Download and configure exact R version (R 4.5.2)
2. Install all Bioconductor packages (DESeq2, etc.)
3. Run the complete analysis pipeline
4. Generate visualizations and tables
5. Generate the HTML report (index.html)
6. Save results to `reports/`

**No manual dependency installation needed.**

### Prerequisites

- **macOS/Linux**: [Install Nix](https://nixos.org/download.html)
- **Windows**: Use [WSL2](https://docs.microsoft.com/en-us/windows/wsl/install) with Linux, or Docker

### Clone This Repository

```bash
git clone https://github.com/Sowmya-Harsh/RNA-Seq_RAP.git
```
---

## Project Structure

```
rnaRAP/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci.yml              # GitHub Actions workflow
â”œâ”€â”€ default.nix                 # Nix environment (generated by rix) - THE KEY FILE
â”œâ”€â”€ gen-env.R                   # Script to regenerate default.nix
â”œâ”€â”€ index.html                  # Rendered report after CI/CD
â”œâ”€â”€ README.md                   # This file
â”œâ”€â”€ run_tests.R                 # Test suite
â”œâ”€â”€ run_pipeline.R              # Main analysis pipeline
â”œâ”€â”€ rnaseq_report.qmd           # Quarto report template
â”œâ”€â”€ analysis_core.R             # Core analysis functions
â””â”€â”€ reports/                    # Generated outputs
    â”œâ”€â”€ pca_condition.png       # PCA plot
    â”œâ”€â”€ top_genes.csv           # Top differentially expressed genes
    â””â”€â”€ [other outputs...]
```

---

## Running the Analysis

### Option 1: One-Command Execution (Recommended)

```bash
# Run everything with pinned dependencies
nix-shell --run "Rscript run_pipeline.R"
```

This is the simplest and most reproducible approach.

### Option 2: Interactive Development

```bash
# Enter the Nix environment
nix-shell

# Step 1: Run tests to verify setup
Rscript run_tests.R

# Step 2: Run the pipeline
Rscript run_pipeline.R

# Exit environment
exit
```

### Option 3: Github Pages:

Check the deployed page in actions or can update and deploy page.

---

## Understanding the Pipeline

### The `default.nix` File: Heart of Reproducibility

This project uses **`default.nix`** (managed by the `rix` R package) for reproducible environments. The file contains all pinned dependencies.

### The `gen-env.R` File:
This R script generates the `default.nix` file with your exact environment.

### Data Flow

```
1. Raw Data (Pasilla data)
        â†“
2. Load data via [load_example_data()]
        â†“
3. DESeq2 Differential Expression Analysis
   - Condition effect analysis
   - Type effect analysis
        â†“
4. Generate Results:
   - Statistics (p-values, log2 fold-changes)
   - Significant genes (padj < 0.05)
        â†“
5. Visualizations [analysis_core.R plotting functions]
        â†“
6. Export Tables [top_genes_table()]
   - Top 20 DE genes and Full results matrix
        â†“
7. Generate Report [rnaseq_report.qmd â†’ quarto_render()]
        â†“
8. Final Output [reports/rnaseq_report.html]
```

---

## GitHub Actions Setup

Automated testing and report generation on every commit!

### CI/CD Pipeline

The `.github/workflows/ci.yml` file automatically:

1. **Installs Nix** on GitHub Actions runner
2. **Creates reproducible environment** using `default.nix`
3. **Runs tests** with `run_tests.R`
4. **Executes pipeline** with `run_pipeline.R`
5. **Verifies outputs** (all expected files exist)
6. **Uploads artifacts** for 30 days
7. **Deploys report** to GitHub Pages
---

## Troubleshooting

### Common Issues and Solutions

#### Issue: `command not found: nix-shell`

```bash
# Nix not installed
# Solution: Install Nix
curl -L https://nixos.org/nix/install | sh
source ~/.profile
```
---

## Modifying the Pipeline

### Adding New R Packages

1. Edit `gen-env.R` - add package name to the list:

```r
# In gen-env.R, find the r_pkgs vector and add your package:
r_pkgs = c("DESeq2", "dplyr", "ggplot2", 
           "YOUR_NEW_PACKAGE",  # â† Add here
           "quarto")
```

2. Regenerate the environment:

```bash
nix-shell -p R rPackages.rix
Rscript gen-env.R
exit

# Now enter the new environment
nix-shell
```

3. Commit the updated `default.nix` to git

### Modifying Analysis Steps

1. Edit `analysis_core.R` for core functions
2. Edit `run_pipeline.R` to change pipeline steps
3. Run locally to test: `nix-shell --run "Rscript run_pipeline.R"`
4. Commit and push to GitHub

---

## Performance Tips

### Speed Up Initial Build

```bash
# Use the rstats-on-nix binary cache for pre-compiled packages
nix-shell -p nix

# Inside nix-shell:
nix-env -iA cachix -f https://cachix.org/api/v1/install
cachix use rstats-on-nix
exit

# Now subsequent runs are much faster
nix-shell --run "Rscript run_pipeline.R"
```
---

## Resources

### DESeq2 and RNA-seq

- [DESeq2 Vignette](https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html)
- [RNA-seq Analysis Course](https://www.bioconductor.org/packages/release/workflows/html/rnaseqGene.html)
- [Modern Statistics for Modern Biology](https://www.huber.embl.de/msmb/)

### Related Tools

- ðŸ³ [Docker](https://www.docker.com/) - Container alternative to Nix

## Acknowledgments

- **Reproducible Pipeline Course**: https://github.com/b-rodrigues/rap4mads_2024
- **rstats-on-nix community**: For excellent R + Nix integration tools
- **Bioconductor**: For DESeq2 and RNA-seq analysis tools

---
